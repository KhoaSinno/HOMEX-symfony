{% extends 'baseAdmin.html.twig' %}

{% block title %}Th√™m m·ªõi l·ªãch cho b√°c sƒ©

{% endblock %}

{% block body %}
	<!-- Page Wrapper -->
	<div class="page-wrapper">
		<div
			class="content container-fluid">

			<!-- Page Header -->
			<div class="page-header">
				<div class="row">
					<div class="col-sm-7 col-auto">
						<h3 class="page-title">T·∫°o l·ªãch l√†m vi·ªác</h3>
						<ul class="breadcrumb">
							<li class="breadcrumb-item">
                                <a href="{{path("app_admin_dashboard")}}">Dashboard</a>
							</li>
							<li class="breadcrumb-item active">T·∫°o l·ªãch l√†m vi·ªác</li>
						</ul>
					</div>
				</div>
			</div>
			<!-- /Page Header -->
			<div class="mb-2">
				<a class="btn btn-sm btn-warning rounded mr-2" href="javascript:history.back();" title="Tr·ªü v·ªÅ">
					<i class="fa fa-arrow-left" aria-hidden="true"></i>
					Tr·ªü v·ªÅ</a>
			</div>

			{{ include('admin/schedule_work/_form.html.twig') }}

		</div>
	</div>

{% endblock %}

{% block JSCustom %}
	<script>

$(document).ready(function () {
    let slotsContainer = $(".time-slot-container");
    let ajaxRequest = null; // Bi·∫øn ƒë·ªÉ l∆∞u request AJAX hi·ªán t·∫°i

    $('#schedule_work_slotDuration').on('change', function () {
        let duration = $(this).val();

    if (duration === "all") {
            // N·∫øu ch·ªçn "T·∫•t c·∫£ th·ªùi gian", reload l·∫°i trang
            location.reload();
        }

        // üîπ L∆∞u l·∫°i danh s√°ch c√°c time slot ƒë√£ ch·ªçn tr∆∞·ªõc khi g·ªçi API
        let selectedSlots = [];
        $('.time-slot-container input:checked').each(function () {
            selectedSlots.push($(this).val());
        });

        // N·∫øu c√≥ request tr∆∞·ªõc ƒë√≥, h·ªßy n√≥
        if (ajaxRequest !== null) {
            ajaxRequest.abort();
        }

        ajaxRequest = $.ajax({
            url: "{{ path('generate_time_slots_create') }}",
            method: "POST",
            data: { duration: duration },
            beforeSend: function () {
                console.log("‚è≥ ƒêang t·∫£i...");
                slotsContainer.html("<p>‚è≥ ƒêang t·∫£i khung gi·ªù...</p>");
            },
            success: function (response) {
                console.log("‚úÖ API Response:", response);

                slotsContainer.empty();

                response.timeSlots.forEach(function (slot, index) {
                    let isChecked = selectedSlots.includes(slot) ? "checked" : ""; // Gi·ªØ l·∫°i tr·∫°ng th√°i ch·ªçn

                    let slotHtml = `
                        <div class="time-slot-item">
                            <input type="checkbox" id="schedule_work_timeSlots_${index}" name="schedule_work[timeSlots][]" value="${slot}" ${isChecked}>
                            <label for="schedule_work_timeSlots_${index}">${slot}</label>
                        </div>
                    `;
                    slotsContainer.append(slotHtml);
                });

                console.log("üìù Time Slots in Form:", $(".time-slot-container").html());
            },
            error: function (xhr, status) {
                if (status !== "abort") {
                    alert("‚ùå L·ªói khi l·∫•y Time Slots!");
                }
            },
            complete: function () {
                ajaxRequest = null;
            }
        });
    });

    // üõ† C·∫≠p nh·∫≠t danh s√°ch tr∆∞·ªõc khi submit
    $('form').on('submit', function () {
        let selectedSlots = [];
        $('.time-slot-container input:checked').each(function () {
            selectedSlots.push($(this).val());
        });

        $("#hidden_timeSlots").val(JSON.stringify(selectedSlots));
    });
});

</script>

<!-- Moment.js (C·∫ßn thi·∫øt cho datetimepicker) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

	<!-- Bootstrap Datetimepicker -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>

<script>
		$(document).ready(function () {
		console.log("DOM Loaded, initializing datetimepicker...");

		// C·∫•u h√¨nh Moment.js ƒë·ªÉ tu·∫ßn b·∫Øt ƒë·∫ßu t·ª´ Th·ª© Hai
		moment.updateLocale('vi', {
		week: {
		dow: 1
		} // dow: 1 => Tu·∫ßn b·∫Øt ƒë·∫ßu t·ª´ Th·ª© Hai
		});

		$('.schedule-datepicker').datetimepicker({
		format: 'DD/MM/YYYY', // ƒê·ªãnh d·∫°ng ng√†y
		locale: 'vi', // Ti·∫øng Vi·ªát (c·∫ßn moment.js)
		showTodayButton: true, // Hi·ªÉn th·ªã n√∫t "H√¥m nay"
		useCurrent: false, // Kh√¥ng t·ª± ƒë·ªông ch·ªçn ng√†y hi·ªán t·∫°i
		sideBySide: true, // Hi·ªÉn th·ªã gi·ªù/ph√∫t c·∫°nh nhau
		toolbarPlacement: 'top', // V·ªã tr√≠ toolbar
		showClear: true, // Hi·ªÉn th·ªã n√∫t "X√≥a"
		showClose: true, // Hi·ªÉn th·ªã n√∫t "ƒê√≥ng"
		defaultDate: new Date()
		});
		});
	</script>

{% endblock %}